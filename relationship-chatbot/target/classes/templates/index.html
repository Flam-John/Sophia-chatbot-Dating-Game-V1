<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Relationship Chatbot</title>
    <style>
      :root {
        --primary-color: #ff69b4;
        --primary-light: #ffe6ff;
        --primary-dark: #cc5599;
        --user-bubble: #dcf8ff;
        --user-bubble-border: #c8e4ff;
        --bot-bubble: #ffe6ff;
        --bot-bubble-border: #ffc8ff;
        --background-color: #f5f5f5;
        --text-color: #333333;
        --timestamp-color: #888888;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }

      body {
        background-color: var(--background-color);
        color: var(--text-color);
        height: 100vh;
        display: flex;
        flex-direction: column;
      }

      .container {
        max-width: 800px;
        margin: 0 auto;
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .header {
        background-color: var(--primary-color);
        color: white;
        padding: 15px 20px;
        border-bottom: 1px solid var(--primary-dark);
        display: flex;
        align-items: center;
      }

      .avatar {
        width: 40px;
        height: 40px;
        background-color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        color: var(--primary-color);
        margin-right: 15px;
      }

      .header-text {
        flex-grow: 1;
      }

      .bot-name {
        font-size: 1.2rem;
        font-weight: bold;
      }

      .status {
        font-size: 0.85rem;
        opacity: 0.9;
      }

      .chat-container {
        flex-grow: 1;
        overflow-y: auto;
        padding: 20px;
        display: flex;
        flex-direction: column;
      }

      .message {
        max-width: 70%;
        margin-bottom: 15px;
        position: relative;
        display: flex;
        gap: 10px;
        align-items: flex-start;
      }

      .message-bubble {
        padding: 12px 15px;
        border-radius: 18px;
        position: relative;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
      }

      .user-message {
        align-self: flex-end;
      }

      .bot-message {
        align-self: flex-start;
      }

      .user-message .message-bubble {
        background-color: var(--user-bubble);
        border: 1px solid var(--user-bubble-border);
        border-bottom-right-radius: 5px;
      }

      .bot-message .message-bubble {
        background-color: var(--bot-bubble);
        border: 1px solid var(--bot-bubble-border);
        border-bottom-left-radius: 5px;
      }

      .message-avatar {
        width: 35px;
        height: 35px;
        background-color: var(--primary-color);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        color: white;
        flex-shrink: 0;
      }

      .timestamp {
        font-size: 0.7rem;
        color: var(--timestamp-color);
        margin-top: 5px;
        text-align: right;
      }

      .input-container {
        display: flex;
        padding: 15px;
        background-color: white;
        border-top: 1px solid #e0e0e0;
      }

      .input-container textarea {
        flex-grow: 1;
        height: 50px;
        border: 1px solid #ddd;
        border-radius: 25px;
        padding: 12px 15px;
        resize: none;
        outline: none;
        font-size: 1rem;
        transition: border 0.3s ease;
      }

      .input-container textarea:focus {
        border-color: var(--primary-color);
      }

      .send-button {
        width: 50px;
        height: 50px;
        background-color: var(--primary-color);
        color: white;
        border: none;
        border-radius: 50%;
        margin-left: 10px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background-color 0.3s ease;
      }

      .send-button:hover {
        background-color: var(--primary-dark);
      }

      .send-button:disabled {
        background-color: #cccccc;
        cursor: not-allowed;
      }

      .typing-indicator {
        display: none;
        align-items: center;
        margin: 10px 0;
        align-self: flex-start;
      }

      .typing-bubble {
        background-color: #e0e0e0;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        margin: 0 2px;
        animation: typing 1s infinite ease-in-out;
      }

      .typing-bubble:nth-child(1) {
        animation-delay: 0s;
      }

      .typing-bubble:nth-child(2) {
        animation-delay: 0.2s;
      }

      .typing-bubble:nth-child(3) {
        animation-delay: 0.4s;
      }

      @keyframes typing {
        0% {
          transform: translateY(0px);
          background-color: #e0e0e0;
        }
        50% {
          transform: translateY(-5px);
          background-color: var(--primary-color);
        }
        100% {
          transform: translateY(0px);
          background-color: #e0e0e0;
        }
      }

      /* Responsive Design */
      @media (max-width: 768px) {
        .message {
          max-width: 85%;
        }
      }

      @media (max-width: 480px) {
        .header {
          padding: 10px;
        }

        .message {
          max-width: 90%;
        }

        .message-bubble {
          padding: 10px 12px;
        }

        .input-container {
          padding: 10px;
        }

        .input-container textarea {
          height: 45px;
          padding: 10px 12px;
        }

        .send-button {
          width: 45px;
          height: 45px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <div class="avatar" id="header-avatar">S</div>
        <div class="header-text">
          <div class="bot-name" id="bot-name">Sophia</div>
          <div class="status" id="status">Online</div>
        </div>
      </div>

      <div class="chat-container" id="chat-container">
        <!-- Messages will be added here dynamically -->
        <div class="typing-indicator" id="typing-indicator">
          <div class="message-avatar" id="typing-avatar">S</div>
          <div class="typing-bubble"></div>
          <div class="typing-bubble"></div>
          <div class="typing-bubble"></div>
        </div>
      </div>

      <div class="input-container">
        <textarea
          id="user-input"
          placeholder="Type a message..."
          rows="1"
        ></textarea>
        <button class="send-button" id="send-button">
          <svg
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              d="M22 2L11 13"
              stroke="white"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            />
            <path
              d="M22 2L15 22L11 13L2 9L22 2Z"
              stroke="white"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            />
          </svg>
        </button>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // DOM Elements
        const chatContainer = document.getElementById("chat-container");
        const userInput = document.getElementById("user-input");
        const sendButton = document.getElementById("send-button");
        const typingIndicator = document.getElementById("typing-indicator");
        const statusElement = document.getElementById("status");
        const botNameElement = document.getElementById("bot-name");
        const headerAvatarElement = document.getElementById("header-avatar");
        const typingAvatarElement = document.getElementById("typing-avatar");

        // API URL
        const API_URL = "/api/chat";

        // Bot Configuration
        let botName = "Sophia";

        // Conversation History
        let conversationHistory = [];

        // Add event listeners
        sendButton.addEventListener("click", sendMessage);
        userInput.addEventListener("keydown", function (e) {
          if (e.key === "Enter" && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
          }
        });

        // Fetch bot configuration
        fetchBotConfig();

        // Add welcome message
        function addWelcomeMessage() {
          setTimeout(() => {
            addBotMessage({
              message: `Hi there! I'm ${botName}. I'm so happy to chat with you today! How are you feeling?`,
              sender: botName,
              timestamp: getCurrentTime(),
            });
          }, 500);
        }

        // Fetch bot configuration from backend
        function fetchBotConfig() {
          fetch(`${API_URL}/config`)
            .then((response) => {
              if (!response.ok) {
                throw new Error("Network response was not ok");
              }
              return response.json();
            })
            .then((config) => {
              botName = config.botName;
              botNameElement.textContent = botName;
              headerAvatarElement.textContent = botName.charAt(0);
              typingAvatarElement.textContent = botName.charAt(0);

              // Add system message to conversation history
              conversationHistory.push({
                role: "system",
                content: config.systemPrompt,
              });

              // Add welcome message
              addWelcomeMessage();
            })
            .catch((error) => {
              console.error("Error fetching bot configuration:", error);
              addWelcomeMessage(); // Add default welcome message on error
            });
        }

        // Send message function
        function sendMessage() {
          const message = userInput.value.trim();
          if (message === "") return;

          // Clear input
          userInput.value = "";

          // Add user message to UI
          addUserMessage({
            message: message,
            sender: "You",
            timestamp: getCurrentTime(),
          });

          // Add user message to conversation history
          conversationHistory.push({
            role: "user",
            content: message,
          });

          // Show typing indicator
          showTypingIndicator();

          // Send message to API
          fetch(`${API_URL}/send`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              message: message,
            }),
          })
            .then((response) => {
              console.log("Response status:", response.status);
              if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
              }
              return response.json();
            })
            .then((data) => {
              console.log("Received data:", data);
              // Hide typing indicator
              hideTypingIndicator();

              // Add bot message to UI
              addBotMessage({
                message: data.message,
                sender: data.sender,
                timestamp: data.timestamp || getCurrentTime(),
              });

              // Add bot message to conversation history
              conversationHistory.push({
                role: "assistant",
                content: data.message,
              });
            })
            .catch((error) => {
              console.error("Error details:", error);
              hideTypingIndicator();

              // Add error message
              addBotMessage({
                message:
                  "Sorry, I'm having trouble connecting right now. Please try again later.",
                sender: botName,
                timestamp: getCurrentTime(),
              });
            });
        }

        // Add user message to UI
        function addUserMessage(messageData) {
          const messageElement = document.createElement("div");
          messageElement.className = "message user-message";

          messageElement.innerHTML = `
                <div class="message-bubble">
                    ${messageData.message}
                    <div class="timestamp">${messageData.timestamp}</div>
                </div>
            `;

          chatContainer.insertBefore(messageElement, typingIndicator);
          scrollToBottom();
        }

        // Add bot message to UI
        function addBotMessage(messageData) {
          const messageElement = document.createElement("div");
          messageElement.className = "message bot-message";

          messageElement.innerHTML = `
                <div class="message-avatar">${messageData.sender.charAt(
                  0
                )}</div>
                <div class="message-bubble">
                    ${messageData.message}
                    <div class="timestamp">${messageData.timestamp}</div>
                </div>
            `;

          chatContainer.insertBefore(messageElement, typingIndicator);
          scrollToBottom();
        }

        // Show typing indicator
        function showTypingIndicator() {
          typingIndicator.style.display = "flex";
          statusElement.textContent = "Typing...";
          scrollToBottom();
          sendButton.disabled = true;
        }

        // Hide typing indicator
        function hideTypingIndicator() {
          typingIndicator.style.display = "none";
          statusElement.textContent = "Online";
          sendButton.disabled = false;
        }

        // Scroll to bottom of chat
        function scrollToBottom() {
          chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // Get current time formatted as HH:MM
        function getCurrentTime() {
          const now = new Date();
          return now.toLocaleTimeString("en-US", {
            hour: "2-digit",
            minute: "2-digit",
            hour12: false,
          });
        }
      });
    </script>
  </body>
</html>
